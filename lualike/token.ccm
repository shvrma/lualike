module;

#include <cstdint>
#include <optional>
#include <string_view>

#include "frozen/string.h"
#include "frozen/unordered_map.h"

export module lualike.token;

export namespace lualike::token {

enum class TokenKind : uint8_t {
  kNone,

  kName,  // Same as identifier
  kStringLiteral,
  kIntLiteral,
  kFloatLiteral,

  kKeywordAnd,
  kKeywordBreak,
  kKeywordDo,
  kKeywordElse,
  kKeywordElseif,
  kKeywordEnd,
  kKeywordFalse,
  kKeywordFor,
  kKeywordFunction,
  kKeywordGoto,
  kKeywordIf,
  kKeywordIn,
  kKeywordLocal,
  kKeywordNil,
  kKeywordNot,
  kKeywordOr,
  kKeywordRepeat,
  kKeywordReturn,
  kKeywordThen,
  kKeywordTrue,
  kKeywordUntil,
  kKeywordWhile,

  kOtherPlus,
  kOtherMinus,
  kOtherAsterisk,
  kOtherSlash,
  kOtherPercent,
  kOtherCaret,  // ^
  kOtherDoubleSlash,
  kOtherDoubleEqual,
  kOtherTildeEqual,  // ~=
  kOtherLessThanEqual,
  kOtherGreaterThanEqual,
  kOtherLessThan,
  kOtherGreaterThan,
  kOtherEqual,
  kOtherLeftParenthesis,
  kOtherRightParenthesis,
  kOtherLeftFigureBracket,
  kOtherRightFigureBracket,
  kOtherLeftSquareBracket,
  kOtherRightSquareBracket,
  kOtherSemicolon,
  kOtherColon,
  kOtherComma,
  kOtherDot,
};

struct Token {
  TokenKind token_kind;
  std::optional<std::string_view> token_data;
  int span_start = -1;
  int span_end = -1;

  bool operator==(const Token &rhs) const = default;
};

constexpr auto kKeywordsMap =
    frozen::make_unordered_map<frozen::string, TokenKind>({
        {"and", TokenKind::kKeywordAnd},
        {"break", TokenKind::kKeywordBreak},
        {"do", TokenKind::kKeywordDo},
        {"else", TokenKind::kKeywordElse},
        {"elseif", TokenKind::kKeywordElseif},
        {"end", TokenKind::kKeywordEnd},
        {"false", TokenKind::kKeywordFalse},
        {"for", TokenKind::kKeywordFor},
        {"function", TokenKind::kKeywordFunction},
        {"goto", TokenKind::kKeywordGoto},
        {"if", TokenKind::kKeywordIf},
        {"in", TokenKind::kKeywordIn},
        {"local", TokenKind::kKeywordLocal},
        {"nil", TokenKind::kKeywordNil},
        {"not", TokenKind::kKeywordNot},
        {"or", TokenKind::kKeywordOr},
        {"repeat", TokenKind::kKeywordRepeat},
        {"return", TokenKind::kKeywordReturn},
        {"then", TokenKind::kKeywordThen},
        {"true", TokenKind::kKeywordTrue},
        {"until", TokenKind::kKeywordUntil},
        {"while", TokenKind::kKeywordWhile},
    });

constexpr auto kOtherSingleCharTokensMap =
    frozen::make_unordered_map<char, TokenKind>({
        {'+', TokenKind::kOtherPlus},
        {'-', TokenKind::kOtherMinus},
        {'*', TokenKind::kOtherAsterisk},
        {'/', TokenKind::kOtherSlash},
        {'%', TokenKind::kOtherPercent},
        {'^', TokenKind::kOtherCaret},
        {'<', TokenKind::kOtherLessThan},
        {'>', TokenKind::kOtherGreaterThan},
        {'=', TokenKind::kOtherEqual},
        {'(', TokenKind::kOtherLeftParenthesis},
        {')', TokenKind::kOtherRightParenthesis},
        {';', TokenKind::kOtherSemicolon},
        {',', TokenKind::kOtherComma},
    });

constexpr auto kOtherTwoCharTokensMap =
    frozen::make_unordered_map<frozen::string, TokenKind>({
        {"//", TokenKind::kOtherDoubleSlash},
        {"==", TokenKind::kOtherDoubleEqual},
        {"~=", TokenKind::kOtherTildeEqual},
        {"<=", TokenKind::kOtherLessThanEqual},
        {">=", TokenKind::kOtherGreaterThanEqual},
    });

}  // namespace lualike::token
